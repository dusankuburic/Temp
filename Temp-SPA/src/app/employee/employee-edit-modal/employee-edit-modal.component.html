<div class="modal-header-obsidian">
    <h4 class="modal-title-obsidian">{{title}}</h4>
    <button type="button" class="modal-close-obsidian" aria-label="Close" (click)="bsModalRef.hide()" (keydown.enter)="bsModalRef.hide()" (keydown.space)="bsModalRef.hide()">
      <span class="modal-close-icon" aria-hidden="true">Ã—</span>
    </button>
</div>
<div class="modal-body-obsidian">
    <tabset>
        <tab heading="Profile">
            <div>
                <form [formGroup]="editEmployeeForm" (ngSubmit)="update()">
                    <div class="employee-edit-grid">
                        <div>
                            <!-- Profile Avatar & Name Header -->
                            <tmp-card variant="subtle" class="employee-profile-card">
                                <div class="employee-profile-header">
                                    <tmp-avatar
                                        [profilePictureUrl]="profilePictureDisplayUrl"
                                        [displayName]="firstName.value + ' ' + lastName.value"
                                        [size]="'large'"
                                        [shape]="'circle'">
                                    </tmp-avatar>
                                    <div class="employee-profile-info">
                                        <h3 class="employee-name">{{firstName.value}} {{lastName.value}}</h3>
                                        @if (username) {
                                        <p class="employee-username">{{username}}</p>
                                        }
                                        
                                        <div class="employee-photo-actions" style="margin-top: 1rem;">
                                            <label class="modal-file-label" for="editProfilePhoto">Change photo</label>
                                            <input
                                                id="editProfilePhoto"
                                                class="modal-file-input"
                                                type="file"
                                                accept="image/*"
                                                (change)="onProfilePhotoSelected($event)">
                    
                                            @if (profilePictureUrl) {
                                                <button type="button" class="modal-file-clear" (click)="clearProfilePhoto()">Remove</button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </tmp-card>

                            <tmp-card variant="filled" class="form-card">
                                <h4 class="section-title">Basic Information</h4>
                                <div class="modal-form-section">
                                    <tmp-input [formControl]="firstName" [label]="'First Name'" [placeholder]="'Enter First Name'"></tmp-input>
                                    <tmp-input [formControl]="lastName" [label]="'Last Name'" [placeholder]="'Enter Last Name'"></tmp-input>
                                </div>
                            </tmp-card>
                        </div>

                        <div>
                            <tmp-card variant="filled" class="form-card">
                                <h4 class="section-title">Organization Structure</h4>
                                <div class="modal-form-section">
                                    <tmp-select
                                        [options]="organizationsSelect"
                                        [label]="'Organization'"
                                        formControlName="organizationId"
                                        (change)="loadInnerGroups(editEmployeeForm.get('organizationId')?.value)">
                                    </tmp-select>
                                    <tmp-select
                                        [options]="innerGroupsSelect"
                                        [label]="'Group'"
                                        formControlName="groupId"
                                        (change)="loadInnerTeams(editEmployeeForm.get('groupId')?.value)">
                                    </tmp-select>
                                    <tmp-select [options]="innerTeamsSelect" [label]="'Team'" formControlName="teamId"></tmp-select>
                                </div>
                            </tmp-card>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <tmp-button type="submit" variant="success" [disabled]="!editEmployeeForm.valid">Save Changes</tmp-button>
                    </div>
                </form>

                @if (employee && employee.role === 'Moderator') {
                <tmp-card variant="filled" class="moderator-card">
                    <h4 class="section-title">Assign Moderator Groups</h4>
                    <div class="modal-form-grid">
                        <div class="group-container">
                            <h5 class="group-subtitle">Current Groups</h5>
                            <tmp-table [hoverable]="true">
                                <thead>
                                    <tr>
                                        <th>Group Name</th>
                                        <th class="text-center">Options</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (group of currentModeratorGroups; track group.id) {
                                    <tr>
                                        <td>{{group.name}}</td>
                                        <td class="text-center">
                                            <tmp-button variant="danger" size="small" (clicked)="updateGroup(employeeId, group.id)" ariaLabel="Remove group {{group.name}}">
                                                <fa-icon [icon]="minusIcon" [size]="'xl'"></fa-icon>
                                            </tmp-button>
                                        </td>
                                    </tr>
                                    }
                                    @if (!currentModeratorGroups || currentModeratorGroups.length === 0) {
                                    <tr>
                                        <td colspan="2" class="empty-state">No groups assigned</td>
                                    </tr>
                                    }
                                </tbody>
                            </tmp-table>
                        </div>

                        <div class="group-container">
                            <h5 class="group-subtitle">Available Groups</h5>
                            <tmp-table [hoverable]="true">
                                <thead>
                                    <tr>
                                        <th>Group Name</th>
                                        <th class="text-center">Options</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (group of freeModeratorGroups; track group.id) {
                                    <tr>
                                        <td>{{group.name}}</td>
                                        <td class="text-center">
                                            <tmp-button variant="success" size="small" (clicked)="updateGroup(employeeId, group.id)" ariaLabel="Add group {{group.name}}">
                                                <fa-icon [icon]="plusIcon" [size]="'xl'"></fa-icon>
                                            </tmp-button>
                                        </td>
                                    </tr>
                                    }
                                    @if (!freeModeratorGroups || freeModeratorGroups.length === 0) {
                                    <tr>
                                        <td colspan="2" class="empty-state">No available groups</td>
                                    </tr>
                                    }
                                </tbody>
                            </tmp-table>
                        </div>
                    </div>
                </tmp-card>
                }
            </div>
        </tab>
        <tab heading="Files">
            <div class="pt-3">
                <div class="employee-files-grid">
                    <tmp-card variant="filled" class="upload-card">
                        <h4 class="section-title">Upload Files</h4>
                        <div class="modal-form-section modal-form-section-tight">
                            <div class="row">
                                <div class="col-6 col-xl-12 mb-3">
                                    @if (employee) {
                                    <tmp-file-upload
                                        [label]="'Upload Photo'"
                                        [fileType]="'Image'"
                                        [maxSizeMB]="5"
                                        [uploadedFiles]="employeeFiles"
                                        [customFolder]="'employees/' + employeeId + '/images'"
                                        [compact]="true"
                                        (fileUploaded)="onFileUploaded($event)"
                                        (fileDeleted)="onFileDeleted($event)">
                                    </tmp-file-upload>
                                    }
                                </div>
                                <div class="col-6 col-xl-12 mb-3">
                                    @if (employee) {
                                    <tmp-file-upload
                                        [label]="'Upload Documents'"
                                        [fileType]="'Document'"
                                        [maxSizeMB]="10"
                                        [uploadedFiles]="employeeFiles"
                                        [customFolder]="'employees/' + employeeId + '/documents'"
                                        [compact]="true"
                                        (fileUploaded)="onFileUploaded($event)"
                                        (fileDeleted)="onFileDeleted($event)">
                                    </tmp-file-upload>
                                    }
                                </div>
                            </div>
                        </div>
                    </tmp-card>

                    <tmp-card variant="filled" class="files-table-card" style="overflow: visible;">
                        <h4 class="section-title">File Library</h4>
                        <tmp-table [hoverable]="true" [data]="paginatedFiles" [columns]="fileColumns">
                            <ng-template #rowTemplate let-file>
                                <tr>
                                    <td class="file-name" [attr.title]="file.name" style="width: 50%;">{{file.displayName || file.name}}</td>
                                    <td style="width: 20%;">{{file.fileTypeDisplay || file.fileType}}</td>
                                    <td class="text-center" style="width: 30%;">
                                        <div class="tmp-button-group justify-content-center">
                                            <tmp-button variant="subtle" size="small" (clicked)="downloadFile(file)" ariaLabel="Download file {{file.displayName}}">
                                                <fa-icon [icon]="downloadIcon" [size]="'xl'"></fa-icon>
                                            </tmp-button>
                                            <tmp-button variant="danger" size="small" (clicked)="removeFile(file)" ariaLabel="Delete file {{file.displayName}}">
                                                <fa-icon [icon]="removeIcon" [size]="'xl'"></fa-icon>
                                            </tmp-button>
                                        </div>
                                    </td>
                                </tr>
                            </ng-template>
                        </tmp-table>
                        <div class="mt-3 d-flex justify-content-center p-2">
                            <tmp-pagination
                                [totalCount]="employeeFiles.length"
                                [pageSize]="pageSize"
                                [pageNumber]="pageNumber"
                                (pageChanged)="onPageChanged($event)">
                            </tmp-pagination>
                        </div>
                    </tmp-card>
                </div>
            </div>
        </tab>
    </tabset>
</div>
